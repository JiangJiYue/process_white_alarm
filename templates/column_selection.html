{% extends "base.html" %}

{% block title %}列选择 - 安全告警路径提取系统{% endblock %}

{% block content %}
<h2>选择输入列和忽略列</h2>

<form method="POST">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>选择输入列</h5>
                    <p class="card-text">请选择您希望模型分析的列（至少选择一列）</p>
                </div>
                <div class="card-body">
                    {% for column in task.columns %}
                    <div class="form-check">
                        <input class="form-check-input column-checkbox" type="checkbox" name="selected_columns" value="{{ column }}" id="selected_{{ loop.index }}" 
                               {% if column in task.selected_columns %}checked{% endif %}>
                        <label class="form-check-label" for="selected_{{ loop.index }}">
                            {{ column }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>选择忽略列</h5>
                    <p class="card-text">请输入需要忽略的列名，多个列名用逗号分隔</p>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="ignored_columns_input" class="form-label">忽略列（多个列名用逗号分隔）：</label>
                        <input type="text" class="form-control" id="ignored_columns_input" name="ignored_columns_input" 
                               value="{{ task.ignored_columns | join(',') if task.ignored_columns else '' }}"
                               placeholder="例如: 数据源,组织机构,时间戳">
                    </div>
                    
                    <div class="form-text">
                        <p class="mb-1"><strong>提示：</strong></p>
                        <ul class="mb-0">
                            <li>如果选择了"过滤条件"列，可以输入其中的键名来忽略特定键值对</li>
                            <li>例如过滤条件内容为：<code>数据源 = "EDR" and 命令行 = "..."</code>，可输入<code>数据源</code>来忽略该键值对</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-3">
        <button type="submit" class="btn btn-primary" id="submit-btn">保存并继续</button>
    </div>
</form>

<div class="mt-4">
    <div class="alert alert-info">
        <h5>💡 使用说明</h5>
        <ul>
            <li><strong>输入列</strong>：选择您希望模型分析的列，系统会将这些列的内容拼接后提供给模型</li>
            <li><strong>忽略列</strong>：如果您选择的某些列包含固定值、元数据或无关上下文，可将其加入忽略列列表</li>
            <li><strong>非键值对格式</strong>：如果"过滤条件"列的内容不是键值对格式（如纯文本），系统会将其作为普通列内容处理</li>
            <li><strong>示例</strong>：如果选择"过滤条件"列，其内容为：<br>
                <code>数据源 = "SIEM" and 命令行 = "powershell -enc ..."</code><br>
                可将"数据源"加入忽略列，系统在拼接时会跳过它，仅保留"命令行"键值对
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 解析过滤条件中的键值对
function parseFilterConditions(filterStr) {
    if (typeof filterStr !== 'string') {
        return [];
    }
    
    // 先按 "and" 分割各个条件
    const conditions = filterStr.split(/\s+and\s+/);
    
    const keys = [];
    // 为每个条件匹配键值对
    for (const condition of conditions) {
        const pattern = /^([^=]+?)\s*=\s*("[^"]*"|'[^']*'|\S+)/;
        const match = condition.match(pattern);
        if (match) {
            const key = match[1].trim();
            keys.push(key);
        }
    }
    
    return keys;
}

// 从多个过滤条件示例中提取所有唯一的键
function extractUniqueFilterKeys(filterSamples) {
    const allKeys = new Set();
    
    if (Array.isArray(filterSamples)) {
        filterSamples.forEach(sample => {
            const keys = parseFilterConditions(String(sample));
            keys.forEach(key => allKeys.add(key));
        });
    }
    
    return Array.from(allKeys);
}

document.addEventListener('DOMContentLoaded', function() {
    // 获取所有输入列的复选框
    const columnCheckboxes = document.querySelectorAll('.column-checkbox');
    const submitBtn = document.getElementById('submit-btn');
    
    // 为每个输入列复选框添加事件监听器
    columnCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', updateIgnoredColumns);
    });
    
    // 更新忽略列选项的函数
    function updateIgnoredColumns() {
        // 获取所有选中的输入列
        const selectedColumns = Array.from(columnCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);
        
        // 获取忽略列容器
        const container = document.getElementById('ignored-columns-container');
        if (!container) return;
        
        const manualInputDiv = document.getElementById('manual-filter-input');
        const filterExamplesTextarea = document.getElementById('filter_examples');
        
        // 获取之前选中的忽略列和过滤条件示例
        const ignoredColumnsData = JSON.parse(container.getAttribute('data-ignored-columns') || '[]');
        let filterSamples = JSON.parse(container.getAttribute('data-filter-samples') || '[]');
        
        // 清空容器
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        
        // 检查是否有选中的列
        if (selectedColumns.length === 0) {
            // 如果没有选中的输入列，显示提示信息
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning';
            alertDiv.textContent = '请至少选择一列作为输入列';
            container.appendChild(alertDiv);
            
            // 禁用提交按钮
            if (submitBtn) {
                submitBtn.disabled = true;
            }
            
            if (manualInputDiv) {
                manualInputDiv.style.display = 'none';
            }
            return;
        } else {
            // 启用提交按钮
            if (submitBtn) {
                submitBtn.disabled = false;
            }
        }
        
        // 检查是否选择了"过滤条件"列
        const hasFilterColumn = selectedColumns.includes("过滤条件");
        
        // 如果选择了"过滤条件"列，显示手动输入区域
        if (hasFilterColumn && manualInputDiv) {
            manualInputDiv.style.display = 'block';
            
            // 如果用户在文本框中输入了内容，则使用用户输入的内容
            if (filterExamplesTextarea) {
                const userInput = filterExamplesTextarea.value.trim();
                if (userInput) {
                    filterSamples = userInput.split(',').map(s => s.trim());
                }
            }
        } else if (manualInputDiv) {
            manualInputDiv.style.display = 'none';
        }
        
        // 收集所有可忽略的项（包括普通列名和过滤条件中的键）
        const ignorableItems = [];
        
        selectedColumns.forEach(function(column) {
            if (column === "过滤条件") {
                // 特殊处理过滤条件列，解析其中的键值对
                const filterKeys = extractUniqueFilterKeys(filterSamples);
                
                if (filterKeys.length > 0) {
                    // 添加过滤条件中的键
                    filterKeys.forEach(key => {
                        ignorableItems.push({
                            value: key,
                            label: `过滤条件: ${key}`,
                            isFilterKey: true
                        });
                    });
                } else {
                    // 如果无法解析键值对，将整个列作为可选项
                    ignorableItems.push({
                        value: column,
                        label: column,
                        isFilterKey: false
                    });
                }
            } else {
                // 普通列
                ignorableItems.push({
                    value: column,
                    label: column,
                    isFilterKey: false
                });
            }
        });
        
        // 为每个可忽略项创建复选框
        ignorableItems.forEach(function(item, index) {
            const div = document.createElement('div');
            div.className = 'form-check';
            
            const input = document.createElement('input');
            input.className = 'form-check-input';
            input.type = 'checkbox';
            input.name = 'ignored_columns';
            input.value = item.value;
            input.id = 'ignored_' + index;
            
            // 检查是否应该选中（如果该列之前被选为忽略列）
            if (ignoredColumnsData && ignoredColumnsData.includes(item.value)) {
                input.checked = true;
            }
            
            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.htmlFor = 'ignored_' + index;
            label.textContent = item.label;
            
            div.appendChild(input);
            div.appendChild(label);
            container.appendChild(div);
        });
    }
    
    // 监听文本框输入事件，实时更新忽略列选项
    const filterExamplesTextarea = document.getElementById('filter_examples');
    if (filterExamplesTextarea) {
        filterExamplesTextarea.addEventListener('input', updateIgnoredColumns);
    }
    
    // 初始化时更新一次忽略列
    updateIgnoredColumns();
    
    // 表单提交前验证
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const selectedColumns = Array.from(columnCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
            
            if (selectedColumns.length === 0) {
                e.preventDefault();
                alert('请至少选择一列作为输入列');
                return false;
            }
        });
    }
});
</script>
{% endblock %}