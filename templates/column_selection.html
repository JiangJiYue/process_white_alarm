{% extends "base.html" %}

{% block title %}åˆ—é€‰æ‹© - å®‰å…¨å‘Šè­¦è·¯å¾„æå–ç³»ç»Ÿ{% endblock %}

{% block content %}
<h2>é€‰æ‹©è¾“å…¥åˆ—å’Œå¿½ç•¥åˆ—</h2>

<form method="POST">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>é€‰æ‹©è¾“å…¥åˆ—</h5>
                    <p class="card-text">è¯·é€‰æ‹©æ‚¨å¸Œæœ›æ¨¡å‹åˆ†æçš„åˆ—ï¼ˆè‡³å°‘é€‰æ‹©ä¸€åˆ—ï¼‰</p>
                </div>
                <div class="card-body">
                    {% for column in task.columns %}
                    <div class="form-check">
                        <input class="form-check-input column-checkbox" type="checkbox" name="selected_columns" value="{{ column }}" id="selected_{{ loop.index }}" 
                               {% if column in task.selected_columns %}checked{% endif %}>
                        <label class="form-check-label" for="selected_{{ loop.index }}">
                            {{ column }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>é€‰æ‹©å¿½ç•¥åˆ—</h5>
                    <p class="card-text">è¯·é€‰æ‹©éœ€è¦å¿½ç•¥çš„åˆ—ï¼ˆè¿™äº›åˆ—å¿…é¡»æ˜¯ä¸Šé¢å·²é€‰æ‹©çš„åˆ—çš„å­é›†ï¼‰</p>
                </div>
                <div class="card-body">
                    <div id="ignored-columns-container" 
                         data-ignored-columns="{{ task.ignored_columns | tojson | forceescape }}"
                         data-selected-columns="{{ task.selected_columns | tojson | forceescape }}"
                         data-filter-samples="{{ task.filter_samples | default([]) | tojson | forceescape }}">
                        {% for column in task.selected_columns %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="ignored_columns" value="{{ column }}" id="ignored_{{ loop.index }}"
                                   {% if column in task.ignored_columns %}checked{% endif %}>
                            <label class="form-check-label" for="ignored_{{ loop.index }}">
                                {{ column }}
                            </label>
                        </div>
                        {% endfor %}
                        
                        <!-- æ·»åŠ æ‰‹åŠ¨è¾“å…¥è¿‡æ»¤æ¡ä»¶ç¤ºä¾‹çš„åŒºåŸŸ -->
                        <div id="manual-filter-input" style="display: none; margin-top: 15px;">
                            <label for="filter_examples" class="form-label">æ‰‹åŠ¨è¾“å…¥è¿‡æ»¤æ¡ä»¶ç¤ºä¾‹ï¼ˆç”¨äºè§£æé”®å€¼å¯¹ï¼Œå¤šä¸ªç¤ºä¾‹ç”¨é€—å·åˆ†éš”ï¼‰ï¼š</label>
                            <textarea class="form-control" id="filter_examples" name="filter_examples" rows="3" 
                                      placeholder="ä¾‹å¦‚: æ•°æ®æº = &quot;EDR&quot; and å‘½ä»¤è¡Œ = &quot;powershell -enc ...&quot;, ç»„ç»‡æœºæ„ = &quot;å®‰å…¨ä¸­å¿ƒ&quot; and æ—¶é—´æˆ³ = &quot;2025-12-01 10:00:00&quot;"></textarea>
                        </div>
                        
                        {% if not task.selected_columns %}
                        <p class="text-muted">è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©è¾“å…¥åˆ—</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-3">
        <button type="submit" class="btn btn-primary">ä¿å­˜å¹¶ç»§ç»­</button>
        <a href="{{ url_for('task_detail', task_id=task.id) }}" class="btn btn-secondary">è·³è¿‡ï¼ˆä½¿ç”¨é»˜è®¤è®¾ç½®ï¼‰</a>
    </div>
</form>

<div class="mt-4">
    <div class="alert alert-info">
        <h5>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h5>
        <ul>
            <li><strong>è¾“å…¥åˆ—</strong>ï¼šé€‰æ‹©æ‚¨å¸Œæœ›æ¨¡å‹åˆ†æçš„åˆ—ï¼Œç³»ç»Ÿä¼šå°†è¿™äº›åˆ—çš„å†…å®¹æ‹¼æ¥åæä¾›ç»™æ¨¡å‹</li>
            <li><strong>å¿½ç•¥åˆ—</strong>ï¼šå¦‚æœæ‚¨é€‰æ‹©çš„æŸäº›åˆ—åŒ…å«å›ºå®šå€¼ã€å…ƒæ•°æ®æˆ–æ— å…³ä¸Šä¸‹æ–‡ï¼Œå¯å°†å…¶åŠ å…¥å¿½ç•¥åˆ—åˆ—è¡¨</li>
            <li><strong>ç‰¹æ®Šå¤„ç†</strong>ï¼šå½“é€‰ä¸­"è¿‡æ»¤æ¡ä»¶"åˆ—æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£æå…¶ä¸­çš„é”®å€¼å¯¹ï¼ˆå¦‚ï¼š<code>æ•°æ®æº = "SIEM"</code>ï¼‰ï¼Œå¹¶å°†è¿™äº›é”®å€¼å¯¹ä½œä¸ºç‹¬ç«‹çš„è¾“å…¥é¡¹</li>
            <li><strong>éé”®å€¼å¯¹æ ¼å¼</strong>ï¼šå¦‚æœ"è¿‡æ»¤æ¡ä»¶"åˆ—çš„å†…å®¹ä¸æ˜¯é”®å€¼å¯¹æ ¼å¼ï¼ˆå¦‚çº¯æ–‡æœ¬ï¼‰ï¼Œç³»ç»Ÿä¼šå°†å…¶ä½œä¸ºæ™®é€šåˆ—å†…å®¹å¤„ç†</li>
            <li><strong>ç¤ºä¾‹</strong>ï¼šå¦‚æœé€‰æ‹©"è¿‡æ»¤æ¡ä»¶"åˆ—ï¼Œå…¶å†…å®¹ä¸ºï¼š<br>
                <code>æ•°æ®æº = "SIEM" and å‘½ä»¤è¡Œ = "powershell -enc ..."</code><br>
                å¯å°†"æ•°æ®æº"åŠ å…¥å¿½ç•¥åˆ—ï¼Œç³»ç»Ÿåœ¨æ‹¼æ¥æ—¶ä¼šè·³è¿‡å®ƒï¼Œä»…ä¿ç•™"å‘½ä»¤è¡Œ"é”®å€¼å¯¹
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// è§£æè¿‡æ»¤æ¡ä»¶ä¸­çš„é”®å€¼å¯¹
function parseFilterConditions(filterStr) {
    if (typeof filterStr !== 'string') {
        return [];
    }
    
    // å…ˆæŒ‰ "and" åˆ†å‰²å„ä¸ªæ¡ä»¶
    const conditions = filterStr.split(/\s+and\s+/);
    
    const keys = [];
    // ä¸ºæ¯ä¸ªæ¡ä»¶åŒ¹é…é”®å€¼å¯¹
    for (const condition of conditions) {
        const pattern = /^([^=]+?)\s*=\s*("[^"]*"|'[^']*'|\S+)/;
        const match = condition.match(pattern);
        if (match) {
            const key = match[1].trim();
            keys.push(key);
        }
    }
    
    return keys;
}

// ä»å¤šä¸ªè¿‡æ»¤æ¡ä»¶ç¤ºä¾‹ä¸­æå–æ‰€æœ‰å”¯ä¸€çš„é”®
function extractUniqueFilterKeys(filterSamples) {
    const allKeys = new Set();
    
    if (Array.isArray(filterSamples)) {
        filterSamples.forEach(sample => {
            const keys = parseFilterConditions(String(sample));
            keys.forEach(key => allKeys.add(key));
        });
    }
    
    return Array.from(allKeys);
}

document.addEventListener('DOMContentLoaded', function() {
    // è·å–æ‰€æœ‰è¾“å…¥åˆ—çš„å¤é€‰æ¡†
    const columnCheckboxes = document.querySelectorAll('.column-checkbox');
    
    // ä¸ºæ¯ä¸ªè¾“å…¥åˆ—å¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    columnCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', updateIgnoredColumns);
    });
    
    // æ›´æ–°å¿½ç•¥åˆ—é€‰é¡¹çš„å‡½æ•°
    function updateIgnoredColumns() {
        // è·å–æ‰€æœ‰é€‰ä¸­çš„è¾“å…¥åˆ—
        const selectedColumns = Array.from(columnCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);
        
        // è·å–å¿½ç•¥åˆ—å®¹å™¨
        const container = document.getElementById('ignored-columns-container');
        const manualInputDiv = document.getElementById('manual-filter-input');
        const filterExamplesTextarea = document.getElementById('filter_examples');
        
        // è·å–ä¹‹å‰é€‰ä¸­çš„å¿½ç•¥åˆ—å’Œè¿‡æ»¤æ¡ä»¶ç¤ºä¾‹
        const ignoredColumnsData = JSON.parse(container.getAttribute('data-ignored-columns') || '[]');
        let filterSamples = JSON.parse(container.getAttribute('data-filter-samples') || '[]');
        
        // æ¸…ç©ºå®¹å™¨
        container.innerHTML = '';
        
        // å¦‚æœæœ‰é€‰ä¸­çš„è¾“å…¥åˆ—ï¼Œåˆ™æ˜¾ç¤ºå¿½ç•¥åˆ—é€‰é¡¹
        if (selectedColumns.length > 0) {
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†"è¿‡æ»¤æ¡ä»¶"åˆ—
            const hasFilterColumn = selectedColumns.includes("è¿‡æ»¤æ¡ä»¶");
            
            // å¦‚æœé€‰æ‹©äº†"è¿‡æ»¤æ¡ä»¶"åˆ—ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥åŒºåŸŸ
            if (hasFilterColumn) {
                manualInputDiv.style.display = 'block';
                
                // å¦‚æœç”¨æˆ·åœ¨æ–‡æœ¬æ¡†ä¸­è¾“å…¥äº†å†…å®¹ï¼Œåˆ™ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„å†…å®¹
                const userInput = filterExamplesTextarea.value.trim();
                if (userInput) {
                    filterSamples = userInput.split(',').map(s => s.trim());
                }
            } else {
                manualInputDiv.style.display = 'none';
            }
            
            // æ”¶é›†æ‰€æœ‰å¯å¿½ç•¥çš„é¡¹ï¼ˆåŒ…æ‹¬æ™®é€šåˆ—åå’Œè¿‡æ»¤æ¡ä»¶ä¸­çš„é”®ï¼‰
            const ignorableItems = [];
            
            selectedColumns.forEach(function(column) {
                if (column === "è¿‡æ»¤æ¡ä»¶") {
                    // ç‰¹æ®Šå¤„ç†è¿‡æ»¤æ¡ä»¶åˆ—ï¼Œè§£æå…¶ä¸­çš„é”®å€¼å¯¹
                    const filterKeys = extractUniqueFilterKeys(filterSamples);
                    
                    if (filterKeys.length > 0) {
                        // æ·»åŠ è¿‡æ»¤æ¡ä»¶ä¸­çš„é”®
                        filterKeys.forEach(key => {
                            ignorableItems.push({
                                value: key,
                                label: `è¿‡æ»¤æ¡ä»¶: ${key}`,
                                isFilterKey: true
                            });
                        });
                    } else {
                        // å¦‚æœæ— æ³•è§£æé”®å€¼å¯¹ï¼Œå°†æ•´ä¸ªåˆ—ä½œä¸ºå¯é€‰é¡¹
                        ignorableItems.push({
                            value: column,
                            label: column,
                            isFilterKey: false
                        });
                    }
                } else {
                    // æ™®é€šåˆ—
                    ignorableItems.push({
                        value: column,
                        label: column,
                        isFilterKey: false
                    });
                }
            });
            
            // ä¸ºæ¯ä¸ªå¯å¿½ç•¥é¡¹åˆ›å»ºå¤é€‰æ¡†
            ignorableItems.forEach(function(item, index) {
                const div = document.createElement('div');
                div.className = 'form-check';
                
                const input = document.createElement('input');
                input.className = 'form-check-input';
                input.type = 'checkbox';
                input.name = 'ignored_columns';
                input.value = item.value;
                input.id = 'ignored_' + index;
                
                // æ£€æŸ¥æ˜¯å¦åº”è¯¥é€‰ä¸­ï¼ˆå¦‚æœè¯¥åˆ—ä¹‹å‰è¢«é€‰ä¸ºå¿½ç•¥åˆ—ï¼‰
                if (ignoredColumnsData && ignoredColumnsData.includes(item.value)) {
                    input.checked = true;
                }
                
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = 'ignored_' + index;
                label.textContent = item.label;
                
                div.appendChild(input);
                div.appendChild(label);
                container.appendChild(div);
            });
        } else {
            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„è¾“å…¥åˆ—ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            const p = document.createElement('p');
            p.className = 'text-muted';
            p.textContent = 'è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©è¾“å…¥åˆ—';
            container.appendChild(p);
            manualInputDiv.style.display = 'none';
        }
    }
    
    // ç›‘å¬æ–‡æœ¬æ¡†è¾“å…¥äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°å¿½ç•¥åˆ—é€‰é¡¹
    const filterExamplesTextarea = document.getElementById('filter_examples');
    if (filterExamplesTextarea) {
        filterExamplesTextarea.addEventListener('input', updateIgnoredColumns);
    }
    
    // åˆå§‹åŒ–æ—¶æ›´æ–°ä¸€æ¬¡å¿½ç•¥åˆ—
    updateIgnoredColumns();
});
</script>
{% endblock %}