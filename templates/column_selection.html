{% extends "base.html" %}

{% block title %}åˆ—é€‰æ‹© - å®‰å…¨å‘Šè­¦è·¯å¾„æå–ç³»ç»Ÿ{% endblock %}

{% block content %}
<h2>é€‰æ‹©è¾“å…¥åˆ—å’Œå¿½ç•¥åˆ—</h2>

<form method="POST">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>é€‰æ‹©è¾“å…¥åˆ—</h5>
                    <p class="card-text">è¯·é€‰æ‹©æ‚¨å¸Œæœ›æ¨¡å‹åˆ†æçš„åˆ—ï¼ˆè‡³å°‘é€‰æ‹©ä¸€åˆ—ï¼‰</p>
                </div>
                <div class="card-body">
                    {% for column in task.columns %}
                    <div class="form-check">
                        <input class="form-check-input column-checkbox" type="checkbox" name="selected_columns" value="{{ column }}" id="selected_{{ loop.index }}" 
                               {% if column in task.selected_columns %}checked{% endif %}>
                        <label class="form-check-label" for="selected_{{ loop.index }}">
                            {{ column }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>é€‰æ‹©å¿½ç•¥åˆ—</h5>
                    <p class="card-text">è¯·é€‰æ‹©éœ€è¦å¿½ç•¥çš„åˆ—ï¼ˆè¿™äº›åˆ—å¿…é¡»æ˜¯ä¸Šé¢å·²é€‰æ‹©çš„åˆ—çš„å­é›†ï¼‰</p>
                </div>
                <div class="card-body">
                    <div id="ignored-columns-container" data-ignored-columns="{{ task.ignored_columns | tojson | forceescape }}">
                        {% for column in task.selected_columns %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="ignored_columns" value="{{ column }}" id="ignored_{{ loop.index }}"
                                   {% if column in task.ignored_columns %}checked{% endif %}>
                            <label class="form-check-label" for="ignored_{{ loop.index }}">
                                {{ column }}
                            </label>
                        </div>
                        {% endfor %}
                        
                        {% if not task.selected_columns %}
                        <p class="text-muted">è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©è¾“å…¥åˆ—</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-3">
        <button type="submit" class="btn btn-primary">ä¿å­˜å¹¶ç»§ç»­</button>
        <a href="{{ url_for('task_detail', task_id=task.id) }}" class="btn btn-secondary">è·³è¿‡ï¼ˆä½¿ç”¨é»˜è®¤è®¾ç½®ï¼‰</a>
    </div>
</form>

<div class="mt-4">
    <div class="alert alert-info">
        <h5>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h5>
        <ul>
            <li><strong>è¾“å…¥åˆ—</strong>ï¼šé€‰æ‹©æ‚¨å¸Œæœ›æ¨¡å‹åˆ†æçš„åˆ—ï¼Œç³»ç»Ÿä¼šå°†è¿™äº›åˆ—çš„å†…å®¹æ‹¼æ¥åæä¾›ç»™æ¨¡å‹</li>
            <li><strong>å¿½ç•¥åˆ—</strong>ï¼šå¦‚æœæ‚¨é€‰æ‹©çš„æŸäº›åˆ—åŒ…å«å›ºå®šå€¼ã€å…ƒæ•°æ®æˆ–æ— å…³ä¸Šä¸‹æ–‡ï¼Œå¯å°†å…¶åŠ å…¥å¿½ç•¥åˆ—åˆ—è¡¨</li>
            <li><strong>ç¤ºä¾‹</strong>ï¼šå¦‚æœé€‰æ‹©"åŸå§‹æ—¥å¿—"åˆ—ï¼Œå…¶å†…å®¹ä¸ºï¼š<br>
                <code>æ•°æ®æº = "SIEM" and å‘½ä»¤è¡Œ = "powershell -enc ..."</code><br>
                å¯å°†"æ•°æ®æº"åŠ å…¥å¿½ç•¥åˆ—ï¼Œç³»ç»Ÿåœ¨æ‹¼æ¥æ—¶ä¼šè·³è¿‡å®ƒï¼Œä»…ä¿ç•™æœ‰æ•ˆéƒ¨åˆ†
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // è·å–æ‰€æœ‰è¾“å…¥åˆ—çš„å¤é€‰æ¡†
    const columnCheckboxes = document.querySelectorAll('.column-checkbox');
    
    // ä¸ºæ¯ä¸ªè¾“å…¥åˆ—å¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    columnCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', updateIgnoredColumns);
    });
    
    // æ›´æ–°å¿½ç•¥åˆ—é€‰é¡¹çš„å‡½æ•°
    function updateIgnoredColumns() {
        // è·å–æ‰€æœ‰é€‰ä¸­çš„è¾“å…¥åˆ—
        const selectedColumns = Array.from(columnCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);
        
        // è·å–å¿½ç•¥åˆ—å®¹å™¨
        const container = document.getElementById('ignored-columns-container');
        
        // è·å–ä¹‹å‰é€‰ä¸­çš„å¿½ç•¥åˆ—
        const ignoredColumnsData = JSON.parse(container.getAttribute('data-ignored-columns') || '[]');
        
        // æ¸…ç©ºå®¹å™¨
        container.innerHTML = '';
        
        // å¦‚æœæœ‰é€‰ä¸­çš„è¾“å…¥åˆ—ï¼Œåˆ™æ˜¾ç¤ºå¿½ç•¥åˆ—é€‰é¡¹
        if (selectedColumns.length > 0) {
            selectedColumns.forEach(function(column, index) {
                const div = document.createElement('div');
                div.className = 'form-check';
                
                const input = document.createElement('input');
                input.className = 'form-check-input';
                input.type = 'checkbox';
                input.name = 'ignored_columns';
                input.value = column;
                input.id = 'ignored_' + index;
                
                // æ£€æŸ¥æ˜¯å¦åº”è¯¥é€‰ä¸­ï¼ˆå¦‚æœè¯¥åˆ—ä¹‹å‰è¢«é€‰ä¸ºå¿½ç•¥åˆ—ï¼‰
                if (ignoredColumnsData && ignoredColumnsData.includes(column)) {
                    input.checked = true;
                }
                
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = 'ignored_' + index;
                label.textContent = column;
                
                div.appendChild(input);
                div.appendChild(label);
                container.appendChild(div);
            });
        } else {
            // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„è¾“å…¥åˆ—ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            const p = document.createElement('p');
            p.className = 'text-muted';
            p.textContent = 'è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©è¾“å…¥åˆ—';
            container.appendChild(p);
        }
    }
});
</script>
{% endblock %}